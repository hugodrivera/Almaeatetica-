<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calendario de Turnos - Alma Est√©tica</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
  <style>
    body {
      background: linear-gradient(120deg, #fce4ec, #f8bbd0);
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    img {
      width: 180px;
      margin-top: 20px;
    }
    h1 {
      color: #c2185b;
      margin-top: 10px;
      font-size: 28px;
    }
    #calendar {
      max-width: 95%;
      margin: 30px auto;
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .fc-event {
      border-radius: 8px;
      padding: 4px;
      font-size: 14px;
    }
    .popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }
    .popup-card {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .popup-card button {
      margin: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .popup-card .editar { background: #c2185b; color: white; }
    .popup-card .eliminar { background: #b71c1c; color: white; }
    .popup-card .cerrar { background: #555; color: white; }
    @keyframes fadeIn {
      from { opacity: 0; } to { opacity: 1; }
    }
  </style>
</head>
<body>

  <img src="logo.jpg" alt="Logo Alma Est√©tica">
  <h1>Calendario de Turnos</h1>

  <div id="calendar"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      const url = 'https://script.google.com/macros/s/AKfycbx14SIRVYRHE9TbuNDSd-bJXOfrVBz6F65rG7PHhBHPPXG7fN9LG4E4j3X6SmznDa08/exec';

      const coloresProfesionales = {
        'Melanie': '#f8bbd0',
        'F√°tima': '#f48fb1',
        'Dr. Maria': '#f06292',
        'Maria': '#ec407a',
        'Cris': '#e91e63',
        'Alis': '#d81b60'
      };

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'es',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'timeGridWeek,dayGridMonth'
        },
        events: [],
        eventClick: function(info) {
          const popup = document.createElement('div');
          popup.className = 'popup';

          const card = document.createElement('div');
          card.className = 'popup-card';

          card.innerHTML = `
            <h3>${info.event.title}</h3>
            <p><strong>Servicio:</strong> ${info.event.extendedProps.servicio}</p>
            <p><strong>Fecha:</strong> ${info.event.startStr.substring(0, 10)}</p>
            <p><strong>Hora:</strong> ${info.event.startStr.substring(11, 16)}</p>
            <button class="editar">Modificar</button>
            <button class="eliminar">Eliminar</button>
            <button class="cerrar">Cerrar</button>
          `;

          popup.appendChild(card);
          document.body.appendChild(popup);

          card.querySelector('.editar').onclick = function() {
            const nuevoNombre = prompt('Nuevo nombre:', info.event.title);
            const nuevoTelefono = prompt('Nuevo tel√©fono:', info.event.extendedProps.telefono);
            const nuevoProfesional = prompt('Nuevo profesional:', info.event.extendedProps.profesional);
            const nuevoServicio = prompt('Nuevo servicio:', info.event.extendedProps.servicio);
            const nuevaFecha = prompt('Nueva fecha (YYYY-MM-DD):', info.event.startStr.substring(0, 10));
            const nuevaHora = prompt('Nueva hora (HH:MM):', info.event.startStr.substring(11, 16));

            if (nuevoNombre && nuevaFecha && nuevaHora) {
              const updatedData = {
                nombre: nuevoNombre,
                telefono: nuevoTelefono,
                profesional: nuevoProfesional,
                servicio: nuevoServicio,
                fecha: nuevaFecha,
                hora: nuevaHora,
                id: info.event.extendedProps.id
              };

              fetch(url + '?_method=PUT', {
                method: 'POST',
                body: JSON.stringify(updatedData)
              })
              .then(response => {
                if (response.ok) {
                  alert('‚úÖ Turno modificado.');
                  window.location.reload();
                } else {
                  alert('‚ùå Error modificando el turno.');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error modificando el turno.');
              });
            }
          };

          card.querySelector('.eliminar').onclick = function() {
            if (confirm('¬øEst√°s seguro de eliminar este turno?')) {
              fetch(url + '?_method=DELETE', {
                method: 'POST',
                body: JSON.stringify({ id: info.event.extendedProps.id })
              })
              .then(response => {
                if (response.ok) {
                  alert('üóëÔ∏è Turno eliminado.');
                  window.location.reload();
                } else {
                  alert('‚ùå Error eliminando el turno.');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error eliminando el turno.');
              });
            }
          };

          card.querySelector('.cerrar').onclick = function() {
            document.body.removeChild(popup);
          };
        }
      });

      calendar.render();

      fetch('https://opensheet.elk.sh/15H4TSdJGTZGJS3VEXQ18bhyJWqJ04Ll-h6Y9LPZt30g/Hoja 1')
        .then(response => response.json())
        .then(data => {
          if (!Array.isArray(data)) throw new Error('Datos no v√°lidos');

          const eventos = data
            .filter(turno => turno.nombre && turno.fecha && turno.hora)
            .map((turno, index) => ({
              title: `${turno.nombre} - ${turno.servicio}`,
              start: `${turno.fecha}T${turno.hora}`,
              backgroundColor: coloresProfesionales[turno.profesional] || '#f8bbd0',
              extendedProps: {
                profesional: turno.profesional || '',
                servicio: turno.servicio || '',
                telefono: turno.telefono || '',
                id: index + 2
              }
            }));

          calendar.addEventSource(eventos);
        })
        .catch(error => {
          console.error('Error cargando turnos:', error);
          alert("‚ö†Ô∏è Hubo un problema al cargar los turnos. Revis√° la hoja de Google.");
        });
    });
  </script>

</body>
</html>
