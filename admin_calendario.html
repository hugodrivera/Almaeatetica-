<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: [],
      eventClick: function(info) {
        const opciones = prompt(`Turno de ${info.event.title}\n\nEscrib√≠:\n- "editar" para modificar\n- "eliminar" para borrar\n\nO dejalo vac√≠o para cancelar`);

        if (opciones === 'editar') {
          const nuevoNombre = prompt('Nuevo nombre:', info.event.title);
          const nuevoTelefono = prompt('Nuevo tel√©fono:', info.event.extendedProps.telefono);
          const nuevoProfesional = prompt('Nuevo profesional:', info.event.extendedProps.profesional);
          const nuevoServicio = prompt('Nuevo servicio:', info.event.extendedProps.servicio);
          const nuevaFecha = prompt('Nueva fecha (YYYY-MM-DD):', info.event.startStr.substring(0, 10));
          const nuevaHora = prompt('Nueva hora (HH:MM):', info.event.startStr.substring(11, 16));

          if (nuevoNombre && nuevaFecha && nuevaHora) {
            const updatedData = {
              nombre: nuevoNombre,
              telefono: nuevoTelefono,
              profesional: nuevoProfesional,
              servicio: nuevoServicio,
              fecha: nuevaFecha,
              hora: nuevaHora,
              id: info.event.extendedProps.id
            };

            fetch('https://script.google.com/macros/s/AKfycbztu5PE7F1l3OaDKaZWKx6FOR-jXV5Qb0y-Q2tEmkpFDfMyly_KGZ6LfyJte_GS1fDX/exec', {
              method: 'PUT',
              body: JSON.stringify(updatedData)
            })
            .then(response => {
              if (response.ok) {
                alert('‚úÖ Turno modificado.');
                window.location.reload();
              } else {
                alert('‚ùå Error modificando el turno.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('‚ùå Error modificando el turno.');
            });
          }
        } else if (opciones === 'eliminar') {
          if (confirm('¬øEst√°s seguro de eliminar este turno?')) {
            const deleteData = { id: info.event.extendedProps.id };

            fetch('https://script.google.com/macros/s/AKfycbztu5PE7F1l3OaDKaZWKx6FOR-jXV5Qb0y-Q2tEmkpFDfMyly_KGZ6LfyJte_GS1fDX/exec', {
              method: 'DELETE',
              body: JSON.stringify(deleteData)
            })
            .then(response => {
              if (response.ok) {
                alert('üóëÔ∏è Turno eliminado.');
                window.location.reload();
              } else {
                alert('‚ùå Error eliminando el turno.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('‚ùå Error eliminando el turno.');
            });
          }
        }
      }
    });

    calendar.render();

    fetch('https://opensheet.elk.sh/15H4TSdJGTZGJS3VEXQ18bhyJWqJ04Ll-h6Y9LPZt30g/Hoja 1')
      .then(response => response.json())
      .then(data => {
        if (!Array.isArray(data)) throw new Error('Datos no v√°lidos');

        const eventos = data
          .filter(turno => turno.nombre && turno.fecha && turno.hora)
          .map((turno, index) => ({
            title: turno.nombre,
            start: `${turno.fecha}T${turno.hora}`,
            extendedProps: {
              profesional: turno.profesional || '',
              servicio: turno.servicio || '',
              telefono: turno.telefono || '',
              id: index + 2 // la fila en la hoja (empieza en 2 porque 1 es encabezado)
            }
          }));

        calendar.addEventSource(eventos);
      })
      .catch(error => {
        console.error('Error cargando turnos:', error);
        alert("‚ö†Ô∏è Hubo un problema al cargar los turnos. Revis√° la hoja de Google.");
      });
  });
</script>
