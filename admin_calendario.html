<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calendario de Turnos - Administración</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
  <style>
    body { background-color: #fce4ec; font-family: Arial, sans-serif; text-align: center; }
    img { width: 180px; margin-top: 20px; }
    h1 { color: #c2185b; margin-top: 10px; }
    #calendar { max-width: 900px; margin: 30px auto; background: white; padding: 20px; border-radius: 10px; }
    .fc-event { cursor: pointer; }
    .modal { display: none; position: fixed; z-index: 999; padding-top: 60px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fff; margin: auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 10px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    input, button { margin: 5px 0; padding: 10px; width: 100%; }
    button { border: none; border-radius: 5px; }
    .edit-btn { background-color: #4caf50; color: white; }
    .cancel-btn { background-color: #ff9800; color: white; }
    .delete-btn { background-color: #f44336; color: white; }
  </style>
</head>
<body>

  <img src="logo.jpg" alt="Logo Alma Estética">
  <h1>Calendario de Turnos1 - Administración</h1>

  <div id="calendar"></div>

  <!-- Modal para editar, cancelar y eliminar -->
  <div id="turnoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h2>Detalle del Turno</h2>
      <input type="text" id="modalNombre" placeholder="Nombre">
      <input type="text" id="modalTelefono" placeholder="Teléfono">
      <input type="text" id="modalProfesional" placeholder="Profesional">
      <input type="text" id="modalServicio" placeholder="Servicio">
      <input type="date" id="modalFecha">
      <input type="time" id="modalHora">
      <button class="edit-btn" onclick="editarTurno()">Editar Turno</button>
      <button class="cancel-btn" onclick="cancelarTurno()">Cancelar Turno</button>
      <button class="delete-btn" onclick="eliminarTurno()">Eliminar Turno</button>
      <button onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwxgTalUfXed3ci5HXwJrGBlfZsnjYKPAFgZOEoQt5s9r3IbKowPxm8RzUfCnAtlMpTXQ/exec';

    let calendar;
    let turnoSeleccionado;

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        eventClick: function(info) {
          turnoSeleccionado = info.event.extendedProps;
          turnoSeleccionado.id = info.event.id;

          document.getElementById('modalNombre').value = info.event.title || '';
          document.getElementById('modalTelefono').value = info.event.extendedProps.telefono || '';
          document.getElementById('modalProfesional').value = info.event.extendedProps.profesional || '';
          document.getElementById('modalServicio').value = info.event.extendedProps.servicio || '';
          document.getElementById('modalFecha').value = info.event.startStr.split('T')[0];
          document.getElementById('modalHora').value = info.event.startStr.split('T')[1].slice(0,5);

          document.getElementById('turnoModal').style.display = 'block';
        },
        events: function(fetchInfo, successCallback, failureCallback) {
          fetch('https://opensheet.elk.sh/15H4TSdJGTZGJS3VEXQ18bhyJWqJ04Ll-h6Y9LPZt30g/Hoja 1')
            .then(response => response.json())
            .then(data => {
              const eventos = data
                .filter(turno => turno.nombre && turno.fecha && turno.hora)
                .map((turno, index) => ({
                  id: index + 2,
                  title: turno.nombre,
                  start: `${turno.fecha}T${turno.hora}`,
                  extendedProps: {
                    telefono: turno.telefono || '',
                    profesional: turno.profesional || '',
                    servicio: turno.servicio || ''
                  }
                }));
              successCallback(eventos);
            })
            .catch(error => {
              console.error('Error cargando turnos:', error);
              alert('⚠️ Hubo un problema cargando los turnos.');
              failureCallback(error);
            });
        }
      });

      calendar.render();
    });

    function cerrarModal() {
      document.getElementById('turnoModal').style.display = 'none';
    }

    function editarTurno() {
      const nuevoTurno = {
        id: turnoSeleccionado.id,
        nombre: document.getElementById('modalNombre').value,
        telefono: document.getElementById('modalTelefono').value,
        profesional: document.getElementById('modalProfesional').value,
        servicio: document.getElementById('modalServicio').value,
        fecha: document.getElementById('modalFecha').value,
        hora: document.getElementById('modalHora').value
      };

      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ accion: 'editar', turno: nuevoTurno }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.text())
      .then(response => {
        if (response === 'OK') {
          alert('Turno editado exitosamente.');
          location.reload();
        } else {
          alert('Error al editar turno.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al editar turno.');
      });
    }

    function cancelarTurno() {
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ accion: 'cancelar', id: turnoSeleccionado.id }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.text())
      .then(response => {
        if (response === 'OK') {
          alert('Turno cancelado.');
          location.reload();
        } else {
          alert('Error al cancelar turno.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al cancelar turno.');
      });
    }

    function eliminarTurno() {
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ accion: 'eliminar', id: turnoSeleccionado.id }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.text())
      .then(response => {
        if (response === 'OK') {
          alert('Turno eliminado.');
          location.reload();
        } else {
          alert('Error al eliminar turno.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar turno.');
      });
    }
  </script>

</body>
</html>