<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n - Alma Est√©tica</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: linear-gradient(120deg, #fce4ec, #f8bbd0);
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #c2185b;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px 5px;
      background-color: #c2185b;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    table {
      width: 95%;
      margin: auto;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8bbd0;
      color: #880e4f;
      font-size: 16px;
    }
    td {
      font-size: 14px;
      color: #555;
    }
    .editar { background: #c2185b; }
    .eliminar { background: #b71c1c; }
    .contador {
      margin: 15px;
      font-size: 18px;
      color: #333;
    }
    .popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .popup-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      text-align: center;
      width: 300px;
    }
    .popup-card input {
      width: 90%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .popup-card button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    #calendar {
      max-width: 900px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      display: none;
    }
  </style>
</head>
<body>

<h1>Panel de Turnos - Alma Est√©tica</h1>
<div>
  <button onclick="mostrarLista()">Ver Lista</button>
  <button onclick="mostrarCalendario()">Ver Calendario</button>
</div>

<div class="contador" id="contadorTurnos">Cargando turnos...</div>

<!-- LISTA -->
<table id="tablaTurnos">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Tel√©fono</th>
      <th>Profesional</th>
      <th>Servicio</th>
      <th>Fecha</th>
      <th>Hora</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="turnos"></tbody>
</table>

<!-- CALENDARIO -->
<div id="calendar"></div>

<script>
const urlScript = 'https://script.google.com/macros/s/AKfycbx14SIRVYRHE9TbuNDSd-bJXOfrVBz6F65rG7PHhBHPPXG7fN9LG4E4j3X6SmznDa08/exec';
const sheetUrl = 'https://opensheet.elk.sh/15H4TSdJGTZGJS3VEXQ18bhyJWqJ04Ll-h6Y9LPZt30g/Hoja 1';

let calendar; // para inicializar calendario despu√©s

function cargarTurnos() {
  fetch(sheetUrl)
    .then(response => response.json())
    .then(data => {
      document.getElementById('turnos').innerHTML = '';
      document.getElementById('contadorTurnos').innerText = `Total de turnos: ${data.length}`;

      if (calendar) {
        calendar.removeAllEvents();
      }

      data.forEach((turno, index) => {
        // Lista
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${turno.nombre}</td>
          <td>${turno.telefono}</td>
          <td>${turno.profesional}</td>
          <td>${turno.servicio}</td>
          <td>${turno.fecha}</td>
          <td>${turno.hora}</td>
          <td>
            <button class="editar" onclick="editarTurno(${index + 2}, '${turno.nombre}', '${turno.telefono}', '${turno.profesional}', '${turno.servicio}', '${turno.fecha}', '${turno.hora}')">Editar</button>
            <button class="eliminar" onclick="eliminarTurno(${index + 2})">Eliminar</button>
          </td>
        `;
        document.getElementById('turnos').appendChild(fila);

        // Calendario
        if (calendar) {
          calendar.addEvent({
            title: turno.nombre,
            start: `${turno.fecha}T${turno.hora}`,
            extendedProps: {
              id: index + 2,
              telefono: turno.telefono,
              profesional: turno.profesional,
              servicio: turno.servicio
            }
          });
        }
      });
    });
}

function editarTurno(id, nombre, telefono, profesional, servicio, fecha, hora) {
  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.innerHTML = `
    <div class="popup-card">
      <h3>Editar Turno</h3>
      <input id="nombre" value="${nombre}">
      <input id="telefono" value="${telefono}">
      <input id="profesional" value="${profesional}">
      <input id="servicio" value="${servicio}">
      <input id="fecha" type="date" value="${fecha}">
      <input id="hora" type="time" value="${hora}">
      <br>
      <button class="guardar" onclick="guardarCambios(${id})">Guardar</button>
      <button class="cerrar" onclick="cerrarPopup()">Cancelar</button>
    </div>
  `;
  document.body.appendChild(popup);
}

function guardarCambios(id) {
  const updatedData = {
    id,
    nombre: document.getElementById('nombre').value,
    telefono: document.getElementById('telefono').value,
    profesional: document.getElementById('profesional').value,
    servicio: document.getElementById('servicio').value,
    fecha: document.getElementById('fecha').value,
    hora: document.getElementById('hora').value
  };

  fetch(urlScript + '?_method=PUT', {
    method: 'POST',
    body: JSON.stringify(updatedData)
  })
  .then(response => {
    if (response.ok) {
      alert('‚úÖ Turno modificado.');
      window.location.reload();
    } else {
      alert('‚ùå Error modificando.');
    }
  });
}

function eliminarTurno(id) {
  if (confirm('¬øEliminar este turno?')) {
    fetch(urlScript + '?_method=DELETE', {
      method: 'POST',
      body: JSON.stringify({ id })
    })
    .then(response => {
      if (response.ok) {
        alert('üóëÔ∏è Turno eliminado.');
        window.location.reload();
      } else {
        alert('‚ùå Error eliminando.');
      }
    });
  }
}

function cerrarPopup() {
  document.querySelector('.popup').remove();
}

function mostrarLista() {
  document.getElementById('tablaTurnos').style.display = 'table';
  document.getElementById('calendar').style.display = 'none';
}

function mostrarCalendario() {
  document.getElementById('tablaTurnos').style.display = 'none';
  document.getElementById('calendar').style.display = 'block';

  // Forzar render para que FullCalendar se vea bien despu√©s de mostrarlo
  setTimeout(() => {
    calendar.render();
  }, 10);
}


document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: [],
    eventClick: function(info) {
      if (confirm(`¬øEditar turno de ${info.event.title}?`)) {
        editarTurno(info.event.extendedProps.id, info.event.title, info.event.extendedProps.telefono, info.event.extendedProps.profesional, info.event.extendedProps.servicio, info.event.startStr.substring(0,10), info.event.startStr.substring(11,16));
      }
    }
  });
  calendar.render();
  cargarTurnos();
});
</script>

</body>
</html>
